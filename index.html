<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolyClone v2.9 - 结算与资产版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.umd.js" onerror="console.error('图表库加载失败')"></script>
    <style>
        .gradient-bg { background: radial-gradient(circle at top right, #1e293b, #020617); }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .chart-container { height: 200px; width: 100%; border-radius: 1rem; overflow: hidden; background: rgba(0,0,0,0.2); }
        .hidden { display: none !important; }
        .admin-border { border: 2px solid rgba(168, 85, 247, 0.4); }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen gradient-bg font-sans">

<div id="gateway" class="fixed inset-0 z-[1000] bg-gray-950 flex items-center justify-center p-6">
    <div class="max-w-md w-full">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-black italic mb-2">POLYCLONE</h1>
            <p class="text-blue-500 font-bold text-[10px] uppercase tracking-widest">Global Terminal</p>
        </div>
        <div class="glass p-8 rounded-[3rem]">
            <input id="uName" type="text" class="w-full bg-black/60 border border-gray-800 p-5 rounded-2xl mb-4 outline-none focus:border-blue-500" placeholder="账户名">
            <input id="uPass" type="password" class="w-full bg-black/60 border border-gray-800 p-5 rounded-2xl mb-6 outline-none focus:border-blue-500" placeholder="密钥">
            <button onclick="handleLogin()" class="w-full bg-blue-600 py-5 rounded-2xl font-black uppercase hover:bg-blue-500 transition">验证进入</button>
        </div>
    </div>
</div>

<div id="mainApp" class="hidden">
    <nav class="border-b border-gray-800 p-5 flex justify-between items-center bg-black/40 backdrop-blur-md sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-black">P</div>
            <span id="userNameDisp" class="font-bold text-sm">---</span>
        </div>
        <div class="flex items-center gap-4">
            <div class="bg-gray-900 px-4 py-2 rounded-xl border border-gray-800 text-xs font-mono">
                $ <span id="userBal" class="text-green-400 font-black">0.00</span>
            </div>
            <button onclick="logout()" class="text-[10px] font-bold text-gray-500">退出</button>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-6 space-y-8">
        <section id="adminPanel" class="hidden space-y-6">
            <div class="p-6 rounded-[2rem] admin-border bg-purple-900/10 flex justify-between items-center">
                <div>
                    <h2 class="text-purple-400 font-black text-[10px] uppercase tracking-tighter">协议税收金库</h2>
                    <div id="vaultAmt" class="text-3xl font-black text-white">0.00</div>
                </div>
                <button onclick="claimFees()" class="bg-purple-600 px-6 py-2 rounded-xl text-xs font-black uppercase">一键收割</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="glass p-6 rounded-[2rem]">
                    <h3 class="text-xs font-black text-purple-400 mb-4 uppercase">发布新题目</h3>
                    <input id="newMarketQ" type="text" class="w-full bg-black/40 border border-gray-800 p-3 rounded-xl mb-3 text-sm" placeholder="预测内容...">
                    <button onclick="createNewMarket()" class="w-full bg-blue-600 py-3 rounded-xl text-xs font-black">上线市场</button>
                </div>
                <div class="glass p-6 rounded-[2rem]">
                    <h3 class="text-xs font-black text-red-400 mb-4 uppercase">判别结果 (Resolve)</h3>
                    <select id="resolveSelect" class="w-full bg-black/40 border border-gray-800 p-3 rounded-xl mb-3 text-sm"></select>
                    <div class="flex gap-2">
                        <button onclick="resolveMarket('YES')" class="flex-1 bg-green-600 py-3 rounded-xl text-xs font-black">YES 赢</button>
                        <button onclick="resolveMarket('NO')" class="flex-1 bg-red-600 py-3 rounded-xl text-xs font-black">NO 赢</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="userPositions" class="space-y-4">
            <h2 class="text-xs font-black text-gray-500 uppercase tracking-widest">我的持仓资产</h2>
            <div id="posList" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs font-mono"></div>
        </section>

        <h2 class="text-xs font-black text-gray-500 uppercase tracking-widest">实时预测市场</h2>
        <div id="marketList" class="space-y-6"></div>
    </main>
</div>

<script>
// --- 核心配置 ---
const ADMIN_ID = "admin1991";
const ADMIN_KEY = "Han183406@";

let markets = JSON.parse(localStorage.getItem('v29_markets')) || [
    { id: 1, q: "2026年人类会登上火星吗？", pool: 5000, yesP: 0.28, history: [{time: Math.floor(Date.now()/1000)-86400, value: 0.2},{time: Math.floor(Date.now()/1000), value: 0.28}], active: true }
];
let userPositions = JSON.parse(localStorage.getItem('v29_pos')) || {}; // 存储格式: { username: [{mid, side, amt}] }

// --- 登录系统 ---
function handleLogin() {
    const u = document.getElementById('uName').value.trim();
    const p = document.getElementById('uPass').value.trim();
    if(u === ADMIN_ID && p !== ADMIN_KEY) return alert("创始人识别失败");
    if(u !== ADMIN_ID) {
        const s = localStorage.getItem(`v29_key_${u}`);
        if(s && s !== p) return alert("密码错误");
        if(!s) localStorage.setItem(`v29_key_${u}`, p);
    }
    localStorage.setItem('v29_session', u);
    if(!localStorage.getItem(`v29_bal_${u}`)) localStorage.setItem(`v29_bal_${u}`, "5000.00");
    renderApp();
}

function renderApp() {
    const user = localStorage.getItem('v29_session');
    if(!user) return;
    document.getElementById('gateway').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('userNameDisp').innerText = user;
    if(user === ADMIN_ID) document.getElementById('adminPanel').classList.remove('hidden');
    updateUI();
}

// --- 核心逻辑 ---
function updateUI() {
    const user = localStorage.getItem('v29_session');
    document.getElementById('userBal').innerText = parseFloat(localStorage.getItem(`v29_bal_${user}`)).toFixed(2);
    document.getElementById('vaultAmt').innerText = parseFloat(localStorage.getItem('v29_fees') || 0).toFixed(2);

    // 渲染市场
    const list = document.getElementById('marketList');
    const activeMarkets = markets.filter(m => m.active);
    list.innerHTML = activeMarkets.map(m => `
        <div class="glass p-8 rounded-[2.5rem] border border-gray-800">
            <div class="flex justify-between items-start mb-2">
                <h3 class="font-bold text-xl">${m.q}</h3>
                <div class="text-right font-black text-blue-400 text-2xl">$${m.yesP.toFixed(2)}</div>
            </div>
            <div id="chart-${m.id}" class="chart-container"></div>
            <div class="flex gap-4">
                <button onclick="trade('${user}', ${m.id}, 'YES')" class="flex-1 bg-blue-600 py-4 rounded-2xl font-black uppercase">买入 YES</button>
                <button onclick="trade('${user}', ${m.id}, 'NO')" class="flex-1 bg-gray-800 py-4 rounded-2xl font-black uppercase">买入 NO</button>
            </div>
        </div>
    `).join('');

    // 渲染图表 (防黑屏处理)
    activeMarkets.forEach(m => {
        if(typeof LightweightCharts !== 'undefined') {
            const chart = LightweightCharts.createChart(document.getElementById(`chart-${m.id}`), {
                layout: { background: { color: 'transparent' }, textColor: '#64748b' },
                grid: { vertLines: { visible: false }, horzLines: { color: '#1e293b' } },
                timeScale: { borderVisible: false }, rightPriceScale: { borderVisible: false },
                handleScroll: false, handleScale: false
            });
            const series = chart.addAreaSeries({ lineColor: '#3b82f6', topColor: 'rgba(59, 130, 246, 0.4)', bottomColor: 'rgba(59, 130, 246, 0)', lineWidth: 3 });
            series.setData(m.history);
            chart.timeScale().fitContent();
        }
    });

    // 渲染持仓
    const posList = document.getElementById('posList');
    const myPos = userPositions[user] || [];
    posList.innerHTML = myPos.map(p => {
        const m = markets.find(x => x.id === p.mid);
        return `<div class="bg-gray-900/50 p-3 rounded-lg border border-gray-800 flex justify-between">
            <span>${m ? m.q.substring(0,10)+'...' : '已结束'} <b class="${p.side==='YES'?'text-blue-400':'text-red-400'}">${p.side}</b></span>
            <span>持仓: $${p.amt}</span>
        </div>`;
    }).join('') || '<p class="text-gray-600">暂无持仓</p>';

    // 更新结算下拉框
    const resolveSelect = document.getElementById('resolveSelect');
    resolveSelect.innerHTML = activeMarkets.map(m => `<option value="${m.id}">${m.q}</option>`).join('');
}

function trade(user, mid, side) {
    const amtStr = prompt(`购买 ${side} 的金额 (USDT):`, "100");
    const amt = parseFloat(amtStr);
    if(isNaN(amt) || amt <= 0) return;
    
    let bal = parseFloat(localStorage.getItem(`v29_bal_${user}`));
    if(bal < amt) return alert("余额不足");

    const m = markets.find(x => x.id === mid);
    const fee = amt * 0.01;
    const net = amt - fee;
    
    // 价格影响
    const change = (net / m.pool) * 0.15;
    m.yesP = (side === 'YES') ? Math.min(0.99, m.yesP + change) : Math.max(0.01, m.yesP - change);
    m.pool += net;
    m.history.push({ time: Math.floor(Date.now()/1000), value: m.yesP });

    // 记录持仓
    if(!userPositions[user]) userPositions[user] = [];
    userPositions[user].push({ mid, side, amt: net });

    localStorage.setItem('v29_fees', (parseFloat(localStorage.getItem('v29_fees')||0) + fee).toFixed(2));
    localStorage.setItem(`v29_bal_${user}`, (bal - amt).toFixed(2));
    localStorage.setItem('v29_markets', JSON.stringify(markets));
    localStorage.setItem('v29_pos', JSON.stringify(userPositions));
    updateUI();
}

function resolveMarket(winSide) {
    const mid = parseInt(document.getElementById('resolveSelect').value);
    const m = markets.find(x => x.id === mid);
    if(!confirm(`确认结算 "${m.q}" 为 ${winSide} 获胜吗？这将向赢家发放资金。`)) return;

    // 结算逻辑
    for(let user in userPositions) {
        let bal = parseFloat(localStorage.getItem(`v29_bal_${user}`));
        userPositions[user] = userPositions[user].filter(p => {
            if(p.mid === mid) {
                if(p.side === winSide) {
                    // 赢家：本金翻倍（简化逻辑：赔率固定）
                    bal += p.amt * 2;
                }
                return false; // 移除已结算持仓
            }
            return true;
        });
        localStorage.setItem(`v29_bal_${user}`, bal.toFixed(2));
    }

    m.active = false; // 市场关闭
    localStorage.setItem('v29_markets', JSON.stringify(markets));
    localStorage.setItem('v29_pos', JSON.stringify(userPositions));
    alert("结算完成，资金已拨付。");
    updateUI();
}

function createNewMarket() {
    const q = document.getElementById('newMarketQ').value.trim();
    if(!q) return;
    markets.push({ id: Date.now(), q, pool: 5000, yesP: 0.5, history: [{time: Math.floor(Date.now()/1000), value: 0.5}], active: true });
    localStorage.setItem('v29_markets', JSON.stringify(markets));
    document.getElementById('newMarketQ').value = "";
    updateUI();
}

function claimFees() {
    const fees = parseFloat(localStorage.getItem('v29_fees') || 0);
    const user = localStorage.getItem('v29_session');
    let bal = parseFloat(localStorage.getItem(`v29_bal_${user}`));
    localStorage.setItem(`v29_bal_${user}`, (bal + fees).toFixed(2));
    localStorage.setItem('v29_fees', "0");
    updateUI();
}

function logout() { localStorage.removeItem('v29_session'); location.reload(); }
window.onload = renderApp;
</script>
</body>
</html>
